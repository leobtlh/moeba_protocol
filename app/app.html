<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mœba Protocol | App</title>

    <!-- FAVICON -->
    <link rel="icon" href="https://github.com/leobtlh/moeba_protocol/blob/main/img/homeMadeLogo.png?raw=true" type="image/png">

    <!-- 1. Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Configuration Tailwind pour le Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom dark shade
                            950: '#020617',
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- 3. Script d'initialisation du thème (Anti-FOUC) -->
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>

    <!-- 4. Chargement de React et ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>

    <!-- 5. Chargement de Prop-Types et Recharts -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>

    <!-- 6. Chargement de Ethers.js (CORRECTIF CDNJS PLUS STABLE) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" xintegrity="sha512-FDcVY+g7vc55I8ZY0C0n8n7qoAVbFmnzz414JIqLuuqiCe3rMZQ52QB1tNRg7pDOcCS5jTKS23IGvBJq7V3Wbw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- 7. Chargement de Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Custom scrollbar for dark mode */
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* --- CSS POUR CACHER LES FLÈCHES DES INPUTS NUMBER --- */
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        /* Firefox */
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 transition-colors duration-300">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Importation sécurisée des composants Recharts depuis l'objet global window.Recharts
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts || {};

        // --- CONSTANTES WEB3 (A REMPLIR POUR LE MODE LIVE) ---
        const FACTORY_ADDRESS = "0x..."; // Adresse du HPIVFactory déployé
        const USDC_ADDRESS = "0x...";    // Adresse de l'USDC

        // --- COMPOSANTS ICONS ---
        const IconWrapper = ({ children, className }) => (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24" height="24" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" strokeWidth="2"
            strokeLinecap="round" strokeLinejoin="round"
            className={className}
          >
            {children}
          </svg>
        );

        const Shield = ({ className }) => <IconWrapper className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconWrapper>;
        const Wind = ({ className }) => <IconWrapper className={className}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const Activity = ({ className }) => <IconWrapper className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Wallet = ({ className }) => <IconWrapper className={className}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconWrapper>;
        const AlertTriangle = ({ className }) => <IconWrapper className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>;
        const TrendingUp = ({ className }) => <IconWrapper className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;
        const Lock = ({ className }) => <IconWrapper className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>;
        const Plus = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
        const ArrowRight = ({ className }) => <IconWrapper className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconWrapper>;
        const ArrowLeft = ({ className }) => <IconWrapper className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>;
        const CheckCircle2 = ({ className }) => <IconWrapper className={className}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></IconWrapper>;
        const Building2 = ({ className }) => <IconWrapper className={className}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconWrapper>;
        const Coins = ({ className }) => <IconWrapper className={className}><circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" /></IconWrapper>;
        const FileText = ({ className }) => <IconWrapper className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>;
        const Info = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></IconWrapper>;
        const X = ({ className }) => <IconWrapper className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const LogOut = ({ className }) => <IconWrapper className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconWrapper>;
        const RefreshCw = ({ className }) => <IconWrapper className={className}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconWrapper>;
        const Zap = ({ className }) => <IconWrapper className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>;

        // Icônes Thème
        const Sun = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41-1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconWrapper>;
        const Moon = ({ className }) => <IconWrapper className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconWrapper>;

        // --- COMPOSANT NOTIFICATION (TOAST) ---
        const NotificationToast = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgClass = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-600' : 'bg-slate-800 dark:bg-slate-700';
            const icon = type === 'error' ? <AlertTriangle className="h-5 w-5" /> : <CheckCircle2 className="h-5 w-5" />;

            return (
                <div className={`fixed bottom-6 right-6 z-[100] ${bgClass} text-white px-6 py-4 rounded-xl shadow-2xl animate-slide-up flex items-center gap-4 max-w-md`}>
                    <div className="shrink-0">{icon}</div>
                    <div className="flex-1 text-sm font-medium">{message}</div>
                    <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full transition-colors">
                        <X className="h-4 w-4" />
                    </button>
                </div>
            );
        };

        // --- GÉNÉRATEUR DE DONNÉES HISTORIQUES (MOCK ORACLE) ---
        const generateMockHistory = (type) => {
            const data = [];
            const now = new Date();
            for (let i = 30; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dayStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
                let risk, trigger1;
                if (type === 'WIND') {
                    risk = Math.min(99, Math.max(0, 5 + (i * 0.2) + (Math.random() * 10 - 5)));
                    trigger1 = Math.min(300, Math.max(0, 50 + (i * 1.5) + (Math.random() * 80 - 20)));
                    data.push({ date: dayStr, risk: risk.toFixed(1), windSpeed: trigger1.toFixed(0) });
                } else {
                    risk = Math.min(99, Math.max(0, 2 + (Math.random() * 5)));
                    if (i === 5) risk = 45;
                    trigger1 = Math.max(0, (Math.random() * 4).toFixed(1));
                    if (i === 5) trigger1 = 6.8;
                    data.push({ date: dayStr, risk: risk.toFixed(1), magnitude: trigger1 });
                }
            }
            return data;
        };

        // --- DONNÉES MOCK ---
        const INITIAL_VAULTS = [
          {
            id: "0x742...d439",
            name: "Florida Wind Season 2026",
            description: "Couverture contre les ouragans de catégorie 4 ou plus frappant la côte de Floride. \n\nConditions de déclenchement :\n- Vitesse du vent > 250 km/h (soutenue pendant 1 min).\n- Zone géographique : Comté de Miami-Dade.\n- Source Oracle : NOAA National Hurricane Center.\n\nEn cas de déclenchement, le paiement est effectué sous 48h via le Smart Contract.",
            insurer: "State Farm Re",
            totalCapacity: 40330000,
            claimAmount: 40000000,
            currentAssets: 4330000,
            juniorCapital: 4000000,
            premium: 330000,
            maturityDate: "18 Jan 2026",
            apr: 25.4,
            riskProb: 12.5,
            status: "OPEN",
            userBalance: 0,
            triggerValue: 250,
            oracleType: 'WIND',
            triggers: [
                { id: 'windSpeed', name: 'Vitesse Vent', unit: 'km/h', color: '#3b82f6', threshold: 250 }
            ],
            history: generateMockHistory('WIND')
          },
          {
            id: "0x891...a122",
            name: "Tokyo Earthquake Bond",
            description: "Obligation catastrophe liée au risque sismique dans la région métropolitaine de Tokyo.\n\nConditions de déclenchement :\n- Magnitude > 7.5 sur l'échelle de Richter.\n- Épicentre : Rayon de 50km autour de la tour de Tokyo.\n- Source Oracle : Japan Meteorological Agency (JMA).\n\nStructure : 100% Fully Funded, aucun risque de crédit assureur.",
            insurer: "Japan Post Insurance",
            totalCapacity: 100000000,
            claimAmount: 100000000,
            currentAssets: 0,
            juniorCapital: 10000000,
            premium: 0,
            maturityDate: "En attente",
            apr: 0,
            riskProb: 4.2,
            status: "PENDING",
            userBalance: 0,
            triggerValue: 7.5,
            oracleType: 'EARTHQUAKE',
            triggers: [
                { id: 'magnitude', name: 'Magnitude', unit: 'Richter', color: '#8b5cf6', threshold: 7.5 }
            ],
            history: generateMockHistory('EARTHQUAKE')
          }
        ];

        const MONTHS = [
            { name: 'Janvier', days: 31 }, { name: 'Février', days: 29 }, { name: 'Mars', days: 31 },
            { name: 'Avril', days: 30 }, { name: 'Mai', days: 31 }, { name: 'Juin', days: 30 },
            { name: 'Juillet', days: 31 }, { name: 'Août', days: 31 }, { name: 'Septembre', days: 30 },
            { name: 'Octobre', days: 31 }, { name: 'Novembre', days: 30 }, { name: 'Décembre', days: 31 }
        ];

        // --- COMPOSANT GRAPHIQUE ---
        const RiskChart = ({ data, triggers }) => {
            const [activeTriggers, setActiveTriggers] = useState([]);
            if (!LineChart) return <div className="p-4 bg-red-50 text-red-600 rounded">Erreur chargement graphique</div>;

            const toggleTrigger = (triggerId) => {
                if (activeTriggers.includes(triggerId)) {
                    setActiveTriggers(activeTriggers.filter(id => id !== triggerId));
                } else {
                    setActiveTriggers([...activeTriggers, triggerId]);
                }
            };

            return (
                <div className="space-y-4">
                    <div className="flex flex-wrap items-center gap-4 mb-2">
                        <div className="flex items-center gap-2">
                            <span className="w-3 h-3 rounded-full bg-orange-500"></span>
                            <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Probabilité Risque (%)</span>
                        </div>
                        {triggers.map(trigger => (
                            <label key={trigger.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 p-1 rounded-lg transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                                <input
                                    type="checkbox"
                                    checked={activeTriggers.includes(trigger.id)}
                                    onChange={() => toggleTrigger(trigger.id)}
                                    className="w-4 h-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-slate-600 dark:bg-slate-900"
                                />
                                <span className="text-sm text-slate-600 dark:text-slate-400" style={{ color: activeTriggers.includes(trigger.id) ? trigger.color : undefined }}>
                                    {trigger.name} ({trigger.unit})
                                </span>
                            </label>
                        ))}
                    </div>

                    <div className="h-[300px] w-full bg-slate-50 dark:bg-slate-900/30 rounded-xl p-2 border border-slate-100 dark:border-slate-700">
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={data} margin={{ top: 5, right: 30, left: 0, bottom: 5 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} className="dark:opacity-10" />
                                <XAxis dataKey="date" tick={{fontSize: 12, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                                <YAxis yAxisId="left" tick={{fontSize: 12, fill: '#f97316'}} axisLine={false} tickLine={false} unit="%" domain={[0, 100]} />
                                <YAxis yAxisId="right" orientation="right" tick={{fontSize: 12, fill: '#64748b'}} axisLine={false} tickLine={false} hide={activeTriggers.length === 0} />
                                <Tooltip contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)', backgroundColor: 'rgba(255, 255, 255, 0.9)' }} labelStyle={{ color: '#0f172a', fontWeight: 'bold' }} />
                                <Legend wrapperStyle={{ paddingTop: '10px' }}/>
                                <Line yAxisId="left" type="monotone" dataKey="risk" name="Probabilité de Sinistre" stroke="#f97316" strokeWidth={3} dot={false} activeDot={{ r: 6 }} />
                                {triggers.map(trigger => (
                                    activeTriggers.includes(trigger.id) && (
                                        <Line key={trigger.id} yAxisId="right" type="monotone" dataKey={trigger.id} name={`${trigger.name} (${trigger.unit})`} stroke={trigger.color} strokeWidth={2} dot={false} strokeDasharray="5 5" />
                                    )
                                ))}
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        // --- APP COMPONENT ---
        function App() {
          const [activeRole, setActiveRole] = useState('investor');
          const [walletConnected, setWalletConnected] = useState(false);
          const [userAddress, setUserAddress] = useState('');
          const [userBalance, setUserBalance] = useState('0.00');
          const [vaults, setVaults] = useState(INITIAL_VAULTS);
          const [selectedVault, setSelectedVault] = useState(null);
          const [depositAmount, setDepositAmount] = useState('');

          // --- MODE LIVE VS SIMULATION ---
          const [isLiveMode, setIsLiveMode] = useState(false); // Default: Simulation

          // État pour le Dark Mode
          const [isDarkMode, setIsDarkMode] = useState(false);

          // État Notification Toast
          const [notification, setNotification] = useState({ message: '', type: 'info' });

          const showNotification = (msg, type = 'info') => {
              setNotification({ message: msg, type });
              setTimeout(() => {
                  setNotification(prev => prev.message === msg ? { message: '', type: 'info' } : prev);
              }, 4000);
          };

          useEffect(() => {
            const isDark = document.documentElement.classList.contains('dark');
            setIsDarkMode(isDark);

            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        const addr = accounts[0];
                        setUserAddress(`${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`);
                        showNotification("Compte changé détecté", 'info');
                        // Optionnel: Re-fetch balance
                    } else {
                        setWalletConnected(false);
                        setUserAddress('');
                        showNotification("Wallet déconnecté", 'info');
                    }
                });
            }
          }, []);

          const toggleTheme = () => {
            if (isDarkMode) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                setIsDarkMode(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                setIsDarkMode(true);
            }
          };

          const [newVaultData, setNewVaultData] = useState({
            name: '',
            description: '',
            cap: 40000000,
            coverage: 40000000,
            juniorPercent: 10,
            junior: 4000000,
            premium: 330000,
            day: '',
            month: 'Janvier',
            year: new Date().getFullYear()
          });

          const [isOvercollateralized, setIsOvercollateralized] = useState(false);

          // --- CONNEXION WALLET AVEC SIGNATURE & BALANCE (VERSION ROBUSTE) ---
          const connectWallet = async () => {
            // Sécurité : Vérifier si Ethers est chargé
            if (!window.ethers) {
                showNotification("Erreur technique : Librairie Web3 non chargée.", 'error');
                return;
            }

            if (typeof window.ethereum !== 'undefined') {
                try {
                    // 1. Demande d'accès (Standard EIP-1102 plus compatible)
                    // On demande d'abord les comptes via l'API native du navigateur
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                    if (!accounts || accounts.length === 0) {
                        showNotification("Aucun compte sélectionné.", 'error');
                        return;
                    }

                    // Initialisation du Provider
                    // Utilisation explicite de window.ethers
                    const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();
                    const address = await signer.getAddress();

                    // 2. SIGNATURE DE MESSAGE (Authentification Sécurisée)
                    try {
                        const messageToSign = `Connexion Mœba Protocol\n\nWallet: ${address}\nNonce: ${Date.now()}`;
                        showNotification("Veuillez signer la demande dans votre wallet...", 'info');

                        // Appel bloquant pour la signature
                        await signer.signMessage(messageToSign);

                        showNotification("Signature valide. Connexion autorisée.", 'success');
                    } catch (signErr) {
                        console.error("Erreur signature:", signErr);
                        showNotification("Connexion annulée : Signature refusée par l'utilisateur.", 'error');
                        return; // Arrêt impératif si pas de signature
                    }

                    // 3. Récupération du SOLDE RÉEL
                    const balanceBig = await provider.getBalance(address);
                    // Utilisation explicite de window.ethers
                    const balanceFmt = window.ethers.utils.formatEther(balanceBig);

                    // Mise à jour State
                    const shortAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                    setWalletConnected(true);
                    setUserAddress(shortAddress);
                    setUserBalance(parseFloat(balanceFmt).toFixed(4));

                    const isRabby = window.ethereum.isRabby;
                    showNotification(`Connecté: ${shortAddress} (${isRabby ? 'Rabby' : 'Wallet'})`, 'success');

                } catch (error) {
                    console.error("Erreur connexion:", error);
                    // Affiche le message d'erreur précis (ex: User rejected the request)
                    showNotification(`Echec connexion: ${error.message || error}`, 'error');
                }
            } else {
                showNotification("Aucun wallet détecté. Veuillez installer Rabby ou MetaMask.", 'error');
            }
          };

          const disconnectWallet = () => {
             setWalletConnected(false);
             setUserAddress('');
             setUserBalance('0.00');
             showNotification("Déconnecté de l'application.", 'info');
          };

          const handleWalletAction = () => {
              if (walletConnected) {
                  if(confirm("Voulez-vous vous déconnecter ?")) disconnectWallet();
              } else {
                  connectWallet();
              }
          };

          const updateJunior = (cap, percent) => {
             const calculatedJunior = (parseFloat(cap || 0) * parseFloat(percent || 0)) / 100;
             return calculatedJunior;
          };

          const getMaxDays = (monthName) => {
              const m = MONTHS.find(mo => mo.name === monthName);
              return m ? m.days : 31;
          };

          // ==========================================================
          // === ACTION CRÉATION DE VAULT (INSURER) ===
          // ==========================================================
          const handleCreateVault = async (e) => {
            e.preventDefault();
            const capVal = parseFloat(newVaultData.cap);
            const premiumVal = parseFloat(newVaultData.premium);
            const claimVal = isOvercollateralized ? parseFloat(newVaultData.coverage) : capVal;

            // Validations de base...
            if (capVal <= 0) { showNotification("Erreur: La capacité doit être supérieure à 0.", 'error'); return; }
            if (claimVal <= 0) { showNotification("Erreur: Le montant assuré doit être supérieur à 0.", 'error'); return; }
            if (!newVaultData.description) { showNotification("Erreur: Description manquante.", 'error'); return; }

            const monthIndex = MONTHS.findIndex(m => m.name === newVaultData.month);
            const selectedDate = new Date(newVaultData.year, monthIndex, newVaultData.day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate < today) { showNotification("Date invalide (passé).", 'error'); return; }

            // --- LOGIQUE LIVE VS SIMULATION ---
            if (isLiveMode) {
                // ============================================
                // === MODE LIVE (Blockchain Interaction) ===
                // ============================================
                if (!walletConnected) { showNotification("Connectez votre wallet pour le mode Live.", 'error'); return; }

                try {
                    const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();
                    // const factory = new window.ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);

                    showNotification("Mode Live: Envoi de la transaction vers la Blockchain...", 'info');

                    /* // DECOMMENTER ICI QUAND FACTORY_ADDRESS EST DEFINIE
                       const diffTime = Math.abs(selectedDate - today);
                       const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                       const tx = await factory.createVault(
                            USDC_ADDRESS,
                            "0x0000000000000000000000000000000000000000",
                            window.ethers.utils.parseUnits(newVaultData.cap.toString(), 6),
                            window.ethers.utils.parseUnits(claimVal.toString(), 6),
                            diffDays,
                            newVaultData.name,
                            newVaultData.description
                       );
                       await tx.wait();
                    */

                    // Pour le moment, simuler le succès même en live pour ne pas casser l'UI sans contrat
                    showNotification("Mode Live: Transaction envoyée (Simulée pour démo car pas d'adresse Factory)", 'success');

                } catch (err) {
                    console.error(err);
                    showNotification("Erreur Blockchain: " + err.message, 'error');
                    return;
                }
            } else {
                // ============================================
                // === MODE SIMULATION (Mock Data) ===
                // ============================================
                const formattedDate = `${newVaultData.day} ${newVaultData.month} ${newVaultData.year}`;
                const simulatedRisk = (Math.random() * 19 + 1).toFixed(1);
                const totalCapacityCalculated = capVal + premiumVal;

                const newVault = {
                    id: `0x${Math.floor(Math.random()*10000)}...new`,
                    name: newVaultData.name || "Nouveau Cat Bond",
                    description: newVaultData.description,
                    insurer: "Moi (Assureur)",
                    totalCapacity: totalCapacityCalculated,
                    claimAmount: claimVal,
                    currentAssets: 0,
                    juniorCapital: parseFloat(newVaultData.junior || 0),
                    premium: 0,
                    maturityDate: formattedDate,
                    apr: 0,
                    riskProb: simulatedRisk,
                    status: "PENDING",
                    userBalance: 0,
                    triggerValue: 0,
                    oracleType: 'WIND',
                    triggers: [{ id: 'windSpeed', name: 'Paramètre', unit: 'unit', color: '#3b82f6' }],
                    history: generateMockHistory('WIND')
                };
                setVaults([...vaults, newVault]);
                showNotification(`Vault créé (Simulation) ! Probabilité: ${simulatedRisk}%`, 'success');
            }

            // Reset form
            setNewVaultData({ ...newVaultData, name: '', description: '', day: '', month: 'Janvier', year: new Date().getFullYear(), coverage: capVal });
            setIsOvercollateralized(false);
          };

          const handleInitializeVault = (vaultId) => {
             // Fonction Purement locale pour l'instant (transition Pending -> Open)
             // En live, cela nécessiterait approve + initializeVault sur le contrat
             const premiumValue = parseFloat(newVaultData.premium || 0);
             const updatedVaults = vaults.map(v => {
               if (v.id === vaultId) {
                 return {
                   ...v,
                   status: "OPEN",
                   premium: premiumValue,
                   currentAssets: v.juniorCapital + premiumValue,
                   apr: ((premiumValue * 100 * 365) / ((v.totalCapacity - premiumValue - v.juniorCapital) * 30)).toFixed(2),
                   maturityDate: v.maturityDate === "En attente" ? new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString() : v.maturityDate
                 };
               }
               return v;
             });
             setVaults(updatedVaults);
             showNotification(isLiveMode ? "Vault Initialisé (Live Mock)" : "Vault Initialisé (Simulation)", 'success');
          };

          // ==========================================================
          // === ACTION DE DÉPÔT (INVESTOR) ===
          // ==========================================================
          const handleDeposit = async () => {
            if (!walletConnected) {
                showNotification("Veuillez d'abord connecter votre wallet.", 'error');
                return;
            }
            if (!selectedVault || !depositAmount) return;
            const amount = parseFloat(depositAmount);
            if (amount <= 0) { showNotification("Montant invalide.", 'error'); return; }

            const remainingCapacity = selectedVault.totalCapacity - selectedVault.currentAssets;
            if (amount > remainingCapacity) {
                showNotification(`Erreur : Dépassement capacité. Max: ${formatCurrency(remainingCapacity)}`, 'error');
                return;
            }

            // --- LOGIQUE LIVE VS SIMULATION ---
            if (isLiveMode) {
                 // ============================================
                 // === MODE LIVE (Blockchain Interaction) ===
                 // ============================================
                 try {
                     const provider = new window.ethers.providers.Web3Provider(window.ethereum);
                     const signer = provider.getSigner();

                     showNotification("Mode Live: Veuillez approuver la transaction...", 'info');

                     /*
                        // DECOMMENTER ICI POUR ACTIVER LA LOGIQUE REELLE
                        const usdc = new window.ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
                        const vault = new window.ethers.Contract(selectedVault.id, VAULT_ABI, signer);
                        const amountWei = window.ethers.utils.parseUnits(amount.toString(), 6);

                        await (await usdc.approve(selectedVault.id, amountWei)).wait();
                        await (await vault.deposit(amountWei, userAddress)).wait();
                     */

                     // Simulation de réussite pour la démo UI en mode Live
                     showNotification("Mode Live: Transaction envoyée (Mockée sans ABI)", 'success');

                 } catch (err) {
                     showNotification("Erreur Blockchain: " + err.message, 'error');
                     return;
                 }
            } else {
                 // ============================================
                 // === MODE SIMULATION (Local State) ===
                 // ============================================
                 const updatedVault = {
                     ...selectedVault,
                     currentAssets: selectedVault.currentAssets + amount,
                     userBalance: selectedVault.userBalance + amount
                 };
                 setSelectedVault(updatedVault);
                 setVaults(vaults.map(v => v.id === selectedVault.id ? updatedVault : v));
                 showNotification(`Dépôt de ${formatCurrency(amount)} confirmé (Simulation).`, 'success');
            }
            setDepositAmount('');
          };

          const handleTriggerOracle = (vaultId) => {
            setVaults(vaults.map(v => v.id === vaultId ? { ...v, status: "TRIGGERED" } : v));
            showNotification("⚠️ ORACLE ALERT : Catastrophe validée. Soft Default activé.", 'error');
          };

          const calculateClaimStats = (vault) => {
              const totalFunds = vault.currentAssets;
              const junior = vault.juniorCapital;
              const premium = vault.premium || 0;
              const riskCapital = totalFunds - premium;
              const senior = Math.max(0, riskCapital - junior);
              const claimNeeded = vault.claimAmount || vault.totalCapacity;
              const juniorPayout = Math.min(junior, claimNeeded);
              const remainingClaim = claimNeeded - juniorPayout;
              const seniorPayout = Math.min(senior, remainingClaim);
              const seniorRemaining = Math.max(0, senior - seniorPayout);
              const recoveryRatio = senior > 0 ? (seniorRemaining / senior) : 0;
              return { recoveryRatio, seniorRemaining };
          };

          const calculatePayoutDetails = (vault) => {
              const { recoveryRatio } = calculateClaimStats(vault);
              const principalRecovered = vault.userBalance * recoveryRatio;
              const seniorCapacity = vault.totalCapacity - vault.juniorCapital - vault.premium;
              const userShare = seniorCapacity > 0 ? (vault.userBalance / seniorCapacity) : 0;
              const yieldPayout = vault.premium * userShare;
              const rwaYield = vault.userBalance * 0.05;
              const totalPayout = principalRecovered + yieldPayout + rwaYield;
              return { principalRecovered, yieldPayout, rwaYield, loss: vault.userBalance - principalRecovered, totalPayout };
          };

          const handleClaim = (vault) => {
              const details = calculatePayoutDetails(vault);
              showNotification(`Réclamation de ${formatCurrency(details.totalPayout)} versée.`, 'success');
              const updatedVault = { ...vault, userBalance: 0 };
              setSelectedVault(updatedVault);
              setVaults(vaults.map(v => v.id === vault.id ? updatedVault : v));
          };

          const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);

          // RENDER
          return (
            <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans animate-fade-in transition-colors duration-300">

              <NotificationToast message={notification.message} type={notification.type} onClose={() => setNotification({message:'', type:'info'})} />

              {/* NAVBAR */}
              <nav className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-50 shadow-sm transition-colors duration-300">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between h-16 items-center">

                    <div className="flex items-center gap-4">
                      <a href="#" className="flex items-center">
                        <img src="https://github.com/leobtlh/moeba_protocol/blob/main/img/homeMadeLogo.png?raw=true" alt="MOEBA" className="h-12 w-auto" />
                      </a>

                      {/* --- SWITCH SIMULATION / LIVE --- */}
                      <div className="hidden md:flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-full ml-4">
                         <button
                            onClick={() => setIsLiveMode(false)}
                            className={`px-3 py-1 text-xs font-bold rounded-full transition-all flex items-center gap-1 ${!isLiveMode ? 'bg-white dark:bg-slate-600 shadow text-slate-900 dark:text-white' : 'text-slate-500 hover:text-slate-700'}`}
                         >
                            <RefreshCw className="h-3 w-3" /> Simulation
                         </button>
                         <button
                            onClick={() => setIsLiveMode(true)}
                            className={`px-3 py-1 text-xs font-bold rounded-full transition-all flex items-center gap-1 ${isLiveMode ? 'bg-red-500 shadow text-white' : 'text-slate-500 hover:text-slate-700'}`}
                         >
                            <Zap className="h-3 w-3" /> Live
                         </button>
                      </div>
                    </div>

                    <div className="flex items-center gap-4">
                      {/* Rôles (Desktop) */}
                      <div className="hidden md:flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 transition-colors">
                        <button onClick={() => { setActiveRole('investor'); setSelectedVault(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'investor' ? 'bg-white dark:bg-slate-700 shadow-sm text-blue-700 dark:text-blue-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Investisseur</button>
                        <button onClick={() => { setActiveRole('insurer'); setSelectedVault(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'insurer' ? 'bg-white dark:bg-slate-700 shadow-sm text-indigo-700 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Assureur</button>
                        <button onClick={() => { setActiveRole('oracle'); setSelectedVault(null); }} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeRole === 'oracle' ? 'bg-white dark:bg-slate-700 shadow-sm text-red-600 dark:text-red-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Oracle</button>
                      </div>

                      <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
                      <button onClick={toggleTheme} className="p-2 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
                        {isDarkMode ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
                      </button>

                      <button onClick={handleWalletAction} className={`flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-colors border group ${walletConnected ? 'bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800 hover:bg-red-50 dark:hover:bg-red-900/30 hover:text-red-700 dark:hover:text-red-400 hover:border-red-200 dark:hover:border-red-800' : 'bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-200 border-transparent'}`}>
                        {walletConnected ? (
                            <>
                                <div className="group-hover:hidden flex items-center gap-2">
                                    <Wallet className="h-4 w-4" />
                                    <div className="flex flex-col items-start leading-none">
                                        <span className="text-xs font-bold">{userBalance} ETH</span>
                                        <span className="text-[10px] opacity-70">{userAddress}</span>
                                    </div>
                                </div>
                                <div className="hidden group-hover:flex items-center gap-2">
                                    <LogOut className="h-4 w-4" />
                                    <span>Déconnecter</span>
                                </div>
                            </>
                        ) : (
                            <><Wallet className="h-4 w-4" /><span>Connecter Wallet</span></>
                        )}
                      </button>
                    </div>
                  </div>
                </div>
              </nav>

              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

                {/* --- DASHBOARD GLOBAL (STATS) --- */}
                {!selectedVault && (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

                      {/* CARTE TVL */}
                      <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="text-sm font-medium text-slate-500 dark:text-slate-400">Total Value Locked (TVL)</p>
                            <h3 className="text-3xl font-bold text-slate-900 dark:text-white mt-2">$44.3M</h3>
                          </div>
                          <div className="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-xl">
                            <Activity className="h-6 w-6 text-blue-600 dark:text-blue-400" />
                          </div>
                        </div>
                        <div className="mt-4 flex items-center text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/30 w-fit px-2 py-1 rounded-full">
                          <TrendingUp className="h-3 w-3 mr-1" /> +2.4% this week
                        </div>
                      </div>

                      {/* CARTE APR */}
                      <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="text-sm font-medium text-slate-500 dark:text-slate-400">Rendement Moyen (APR)</p>
                            <h3 className="text-3xl font-bold text-slate-900 dark:text-white mt-2">18.5%</h3>
                          </div>
                          <div className="p-3 bg-green-50 dark:bg-green-900/30 rounded-xl">
                            <TrendingUp className="h-6 w-6 text-green-600 dark:text-green-400" />
                          </div>
                        </div>
                        <div className="mt-4 text-sm text-slate-500 dark:text-slate-400">
                          Boosté par les primes d'assurance
                        </div>
                      </div>

                      {/* CARTE SÉCURITÉ */}
                      <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="text-sm font-medium text-slate-500 dark:text-slate-400">Capital Sécurisé</p>
                            <h3 className="text-3xl font-bold text-slate-900 dark:text-white mt-2">100%</h3>
                          </div>
                          <div className="p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-xl">
                            <Lock className="h-6 w-6 text-indigo-600 dark:text-indigo-400" />
                          </div>
                        </div>
                        <div className="mt-4 text-sm text-slate-500 dark:text-slate-400">
                          Modèle Fully Funded (VUSA)
                        </div>
                      </div>
                    </div>
                )}

                {/* --- VUE INVESTISSEUR --- */}
                {activeRole === 'investor' && (
                  <div className="space-y-6 animate-in fade-in duration-500">

                    {/* LISTE DES VAULTS */}
                    {!selectedVault && (
                        <div className="space-y-6">
                            <div className="flex justify-between items-end">
                              <div>
                                <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Opportunités de Vaults</h2>
                                <p className="text-slate-500 dark:text-slate-400 mt-1">Investissez dans des risques paramétriques sécurisés par la blockchain.</p>
                              </div>
                              <div className="text-sm font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-4 py-2 rounded-full flex items-center gap-2">
                                <Shield className="h-4 w-4" /> Audité & Régulé
                              </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                              {vaults.map((vault) => (
                                <div
                                    key={vault.id}
                                    onClick={() => setSelectedVault(vault)}
                                    className={`group relative bg-white dark:bg-slate-800 rounded-2xl border transition-all cursor-pointer ${vault.status === 'TRIGGERED' ? 'border-red-200 dark:border-red-900 bg-red-50/50 dark:bg-red-900/20' : 'border-slate-200 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-500 hover:shadow-lg'}`}
                                >
                                  <div className="absolute top-6 right-6">
                                    {vault.status === 'OPEN' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 flex items-center gap-1"><CheckCircle2 className="h-3 w-3" /> OPEN</span>}
                                    {vault.status === 'PENDING' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 flex items-center gap-1"><Activity className="h-3 w-3" /> PENDING</span>}
                                    {vault.status === 'TRIGGERED' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-400 flex items-center gap-1"><AlertTriangle className="h-3 w-3" /> CATASTROPHE</span>}
                                  </div>

                                  <div className="p-8">
                                    <div className="mb-6">
                                      <h3 className="text-xl font-bold text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">{vault.name}</h3>
                                      <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-2">
                                        <Building2 className="h-3 w-3" /> Assureur: {vault.insurer}
                                      </p>
                                    </div>

                                    <div className="flex justify-between items-end mb-6">
                                      <div>
                                        <p className="text-sm text-slate-500 dark:text-slate-400 mb-1">Rendement (APR)</p>
                                        <p className={`text-4xl font-bold ${vault.status === 'OPEN' ? 'text-green-600 dark:text-green-400' : 'text-slate-400 dark:text-slate-500'}`}>
                                          {vault.apr}%
                                        </p>
                                      </div>
                                      <div className="text-right">
                                        <p className="text-sm text-slate-500 dark:text-slate-400 mb-1">Levée de Fonds</p>
                                        <p className="text-lg font-semibold text-slate-900 dark:text-white">
                                          {formatCurrency(vault.currentAssets)} <span className="text-slate-400 dark:text-slate-500 text-sm font-normal">/ {formatCurrency(vault.totalCapacity)}</span>
                                        </p>
                                      </div>
                                    </div>

                                    <div className="flex justify-between items-center mb-3">
                                        <span className="text-sm font-medium text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                            <AlertTriangle className="h-3 w-3 text-orange-500" /> Probabilité de sinistre
                                        </span>
                                        <span className={`text-sm font-bold ${vault.riskProb > 10 ? 'text-red-600 dark:text-red-400' : 'text-orange-500 dark:text-orange-400'}`}>
                                            {vault.riskProb}%
                                        </span>
                                    </div>

                                    <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-3 mb-6 overflow-hidden">
                                      <div
                                        className={`h-full rounded-full transition-all duration-1000 ${vault.status === 'TRIGGERED' ? 'bg-red-500' : 'bg-blue-600'}`}
                                        style={{ width: `${(vault.currentAssets / vault.totalCapacity) * 100}%` }}
                                      ></div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 mb-6 text-sm">
                                      <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                        <p className="text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider mb-1">Protection Junior</p>
                                        <p className="font-semibold text-slate-900 dark:text-white">{formatCurrency(vault.juniorCapital)}</p>
                                      </div>
                                      <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                                        <p className="text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider mb-1">Maturité</p>
                                        <p className="font-semibold text-slate-900 dark:text-white">{vault.maturityDate}</p>
                                      </div>
                                    </div>

                                    <div className="flex justify-center items-center gap-2 text-blue-600 dark:text-blue-400 text-sm font-medium">
                                        <span>Voir Détails & Investir</span> <ArrowRight className="h-4 w-4" />
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                        </div>
                    )}

                    {/* VUE DÉTAILLÉE DU VAULT */}
                    {selectedVault && (
                        <div className="space-y-6">
                            <button
                                onClick={() => setSelectedVault(null)}
                                className="flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 font-medium transition-colors"
                            >
                                <ArrowLeft className="h-4 w-4" /> Retour aux Vaults
                            </button>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 space-y-6">

                                    {/* En-tête du Vault */}
                                    <div className={`p-8 rounded-2xl border ${selectedVault.status === 'TRIGGERED' ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="flex items-center gap-3 mb-2">
                                                    <h1 className={`text-3xl font-bold ${selectedVault.status === 'TRIGGERED' ? 'text-red-700 dark:text-red-400' : 'text-slate-900 dark:text-white'}`}>
                                                        {selectedVault.status === 'TRIGGERED' && "⚠ "}{selectedVault.name}
                                                    </h1>
                                                    {selectedVault.status === 'OPEN' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 flex items-center gap-1">OPEN</span>}
                                                    {selectedVault.status === 'TRIGGERED' && <span className="px-3 py-1 rounded-full text-xs font-bold bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-400 flex items-center gap-1">CATASTROPHE</span>}
                                                </div>
                                                <p className="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2 mt-1">
                                                    <Building2 className="h-4 w-4" /> Assureur : <span className="font-semibold">{selectedVault.insurer}</span>
                                                    <span className="mx-2">•</span>
                                                    ID : <span className="font-mono bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-xs">{selectedVault.id}</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Alerte si déclenché */}
                                    {selectedVault.status === 'TRIGGERED' && (
                                        <div className="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-600 p-6 rounded-r-xl">
                                            <h4 className="text-xl font-bold text-red-800 dark:text-red-300 mb-2 flex items-center gap-2">
                                                <AlertTriangle className="h-6 w-6" /> Catastrophe Confirmée
                                            </h4>
                                            <p className="text-red-700 dark:text-red-200 mb-4 text-sm leading-relaxed">
                                                L'oracle a détecté un événement dépassant les seuils critiques. Le mécanisme de "Soft Default" est activé.
                                            </p>

                                            {selectedVault.userBalance > 0 ? (
                                                <div className="bg-white/60 dark:bg-black/20 p-4 rounded-lg border border-red-100 dark:border-red-900/30">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-sm font-medium text-red-800 dark:text-red-300">Votre Solde Initial</span>
                                                        <span className="font-mono font-bold text-slate-600 dark:text-slate-400">{formatCurrency(selectedVault.userBalance)}</span>
                                                    </div>
                                                    {(() => {
                                                        const details = calculatePayoutDetails(selectedVault);
                                                        return (
                                                            <div className="space-y-1 my-3 text-sm">
                                                                <div className="flex justify-between text-red-600 dark:text-red-400">
                                                                    <span>- Perte (Sinistre)</span>
                                                                    <span>{formatCurrency(details.loss)}</span>
                                                                </div>
                                                                <div className="flex justify-between text-green-600 dark:text-green-400">
                                                                    <span>+ 5% Yield RWA (Base)</span>
                                                                    <span>{formatCurrency(details.rwaYield)}</span>
                                                                </div>
                                                                <div className="flex justify-between text-green-600 dark:text-green-400">
                                                                    <span>+ Part de Prime (Yield)</span>
                                                                    <span>{formatCurrency(details.yieldPayout)}</span>
                                                                </div>
                                                            </div>
                                                        );
                                                    })()}
                                                    <div className="h-px bg-red-200 dark:bg-red-800 my-2"></div>
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-lg font-bold text-red-900 dark:text-white">Montant Récupérable</span>
                                                        <span className="font-mono text-xl font-bold text-green-600 dark:text-green-400">
                                                            {formatCurrency(calculatePayoutDetails(selectedVault).totalPayout)}
                                                        </span>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-center p-3 bg-red-100/50 dark:bg-red-900/30 rounded-lg text-red-800 dark:text-red-200 text-sm font-medium">
                                                    Vous n'avez pas de position active.
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Description */}
                                    <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700">
                                        <h4 className="text-lg font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-4 flex items-center gap-2">
                                            <FileText className="h-5 w-5 text-blue-600 dark:text-blue-400"/> Conditions de Déclenchement
                                        </h4>
                                        <div className="bg-slate-50 dark:bg-slate-900/50 p-6 rounded-xl border border-slate-100 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-300 whitespace-pre-line leading-relaxed">
                                            {selectedVault.description || "Aucune description détaillée fournie par l'assureur."}
                                        </div>
                                    </section>

                                    {/* Transparence */}
                                    <section className="bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl p-8 border border-indigo-100 dark:border-indigo-800">
                                        <h4 className="text-lg font-bold text-indigo-900 dark:text-indigo-300 uppercase tracking-wider mb-4 flex items-center gap-2">
                                            <Info className="h-5 w-5 text-indigo-600 dark:text-indigo-400"/> Mécanisme de Transparence
                                        </h4>
                                        <p className="text-sm text-indigo-800 dark:text-indigo-200 leading-relaxed mb-4">
                                            Pour garantir l'équité ("Fairplay"), ce vault sépare strictement les fonds :
                                        </p>
                                        <ul className="list-disc list-inside text-sm text-indigo-700 dark:text-indigo-300 space-y-2">
                                            <li><strong>Poche de Risque (Risk Capital) :</strong> Composée de la Tranche Junior (Assureur) et de la Tranche Senior (Investisseurs). C'est le seul capital utilisé pour payer les sinistres.</li>
                                            <li><strong>Réserve de Rendement (Yield Reserve) :</strong> Composée de la Prime versée par l'assureur. Cette poche est <strong>sanctuarisée</strong> et ne sert jamais à payer les sinistres.</li>
                                        </ul>
                                    </section>

                                    {/* Données Financières */}
                                    <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700">
                                        <h4 className="text-lg font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-6 flex items-center gap-2">
                                            <Activity className="h-5 w-5 text-green-600 dark:text-green-400"/> Données Financières
                                        </h4>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-6">
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Capacité Totale (Hard Cap)</p>
                                                <p className="text-xl font-bold text-slate-900 dark:text-white">{formatCurrency(selectedVault.totalCapacity)}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Inclus Capital Risque + Prime</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold text-indigo-600 dark:text-indigo-400">Tranche Junior (First Loss)</p>
                                                <p className="text-xl font-bold text-indigo-600 dark:text-indigo-400">{formatCurrency(selectedVault.juniorCapital)}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Capital Assureur à risque</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold text-green-600 dark:text-green-400">Réserve de Prime (Yield)</p>
                                                <p className="text-xl font-bold text-green-600 dark:text-green-400">{formatCurrency(selectedVault.premium)}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Sanctuarisée pour les investisseurs</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Liquidité Totale (TVL)</p>
                                                <p className="text-xl font-bold text-slate-900 dark:text-white">{formatCurrency(selectedVault.currentAssets)}</p>
                                                <p className="text-[10px] text-slate-400 mt-1">Fonds présents dans le contrat</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Capacité Investisseurs</p>
                                                <p className="text-xl font-bold text-blue-600 dark:text-blue-400">
                                                    {formatCurrency(selectedVault.totalCapacity - selectedVault.juniorCapital - selectedVault.premium)}
                                                </p>
                                                <p className="text-[10px] text-slate-400 mt-1">Espace Senior Strict (Cap - Junior)</p>
                                            </div>
                                            <div className="bg-slate-50 dark:bg-slate-900/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 uppercase font-semibold">Sur-Collatéralisation</p>
                                                <p className="text-xl font-bold text-slate-900 dark:text-white">
                                                    {selectedVault.totalCapacity > selectedVault.claimAmount ?
                                                        ((selectedVault.totalCapacity / selectedVault.claimAmount) * 100).toFixed(0) + '%'
                                                        : '100%'}
                                                </p>
                                                <p className="text-[10px] text-slate-400 mt-1">Ratio Couverture / Risque</p>
                                            </div>
                                        </div>
                                    </section>

                                    {/* Avertissement Risque */}
                                    <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-800 p-6 rounded-2xl flex gap-4">
                                        <AlertTriangle className="h-6 w-6 text-blue-600 dark:text-blue-400 shrink-0 mt-1" />
                                        <div>
                                            <p className="text-base font-bold text-blue-900 dark:text-blue-300 mb-2">Profil de Risque</p>
                                            <p className="text-sm text-blue-700 dark:text-blue-400 leading-relaxed">
                                                En investissant dans {selectedVault.name}, vous acceptez une probabilité de sinistre de <strong>{selectedVault.riskProb}%</strong>. Le rendement cible est de {selectedVault.apr}%. Le capital est protégé par la Tranche Junior de l'assureur en "First Loss".
                                            </p>
                                        </div>
                                    </div>

                                    {/* Graphique Risque */}
                                    <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 border border-slate-200 dark:border-slate-700">
                                        <h4 className="text-lg font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-6 flex items-center gap-2">
                                            <TrendingUp className="h-5 w-5 text-orange-600 dark:text-orange-400"/> Évolution du Risque & Triggers
                                        </h4>
                                        <div className="mb-4 text-sm text-slate-600 dark:text-slate-400">
                                            Suivi en temps réel de la probabilité de déclenchement calculée par le modèle et des données brutes des capteurs Oracle.
                                        </div>
                                        <RiskChart data={selectedVault.history || []} triggers={selectedVault.triggers || []} />
                                    </section>
                                </div>

                                <div className="lg:col-span-1">
                                    <div className="sticky top-24 space-y-6">
                                        <div className={`bg-white dark:bg-slate-800 rounded-2xl p-6 border shadow-xl ${selectedVault.status === 'TRIGGERED' ? 'border-red-200 dark:border-red-800 shadow-red-100 dark:shadow-none' : 'border-slate-200 dark:border-slate-700 shadow-slate-100 dark:shadow-none'}`}>
                                            <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                                                <Wallet className="h-5 w-5" />
                                                {selectedVault.status === 'OPEN' ? "Investir" : "Gestion"}
                                            </h3>

                                            {selectedVault.status === 'OPEN' ? (
                                                <div className="space-y-6">
                                                    <div>
                                                        <div className="flex justify-between items-center mb-2">
                                                            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">Montant (USDC)</label>
                                                            <span className="text-xs text-slate-500 dark:text-slate-400">
                                                                Max: {formatCurrency(
                                                                    (selectedVault.totalCapacity - selectedVault.juniorCapital - selectedVault.premium) -
                                                                    (selectedVault.currentAssets - selectedVault.juniorCapital - selectedVault.premium)
                                                                )}
                                                            </span>
                                                        </div>
                                                        <div className="relative">
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                step="0.01"
                                                                value={depositAmount}
                                                                onChange={(e) => setDepositAmount(e.target.value)}
                                                                className="w-full pl-4 pr-16 py-4 border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium text-lg"
                                                                placeholder="0.00"
                                                            />
                                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">USDC</span>
                                                        </div>
                                                    </div>

                                                    <div className="space-y-3 pt-2">
                                                        <div className="flex justify-between text-sm">
                                                            <span className="text-slate-500 dark:text-slate-400">APY Estimé</span>
                                                            <span className="font-bold text-green-600 dark:text-green-400">{selectedVault.apr}%</span>
                                                        </div>
                                                        <div className="flex justify-between text-sm">
                                                            <span className="text-slate-500 dark:text-slate-400">Frais d'entrée</span>
                                                            <span className="font-medium text-slate-900 dark:text-white">0.00%</span>
                                                        </div>
                                                    </div>

                                                    <button
                                                        onClick={handleDeposit}
                                                        className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 dark:shadow-none transition-all flex justify-center items-center gap-2"
                                                    >
                                                        Confirmer le Dépôt <ArrowRight className="h-4 w-4" />
                                                    </button>
                                                    <p className="text-xs text-center text-slate-400 dark:text-slate-500">
                                                        En déposant, vous acceptez les conditions du Smart Contract.
                                                    </p>
                                                </div>
                                            ) : selectedVault.status === 'TRIGGERED' ? (
                                                <div className="space-y-4">
                                                    <div className="bg-red-50 dark:bg-red-900/30 p-4 rounded-xl border border-red-100 dark:border-red-800 mb-4">
                                                        <p className="text-sm text-red-800 dark:text-red-200 font-medium text-center">
                                                            Les retraits sont restreints suite à l'événement.
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => handleClaim(selectedVault)}
                                                        disabled={selectedVault.userBalance <= 0}
                                                        className={`w-full py-4 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg transition-all ${
                                                            selectedVault.userBalance > 0
                                                            ? 'bg-red-600 hover:bg-red-700 text-white shadow-red-200 dark:shadow-none'
                                                            : 'bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500 cursor-not-allowed'
                                                        }`}
                                                    >
                                                        <Coins className="h-5 w-5" />
                                                        {selectedVault.userBalance > 0 ? "Réclamer Solde Restant" : "Fonds Réclamés"}
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-slate-500 dark:text-slate-400 font-medium bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-dashed border-slate-200 dark:border-slate-700">
                                                    Ce vault n'est pas ouvert aux investissements pour le moment.
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-5 border border-slate-200 dark:border-slate-700">
                                            <h5 className="font-bold text-slate-900 dark:text-white text-sm mb-3">Besoin d'aide ?</h5>
                                            <ul className="text-sm space-y-2 text-slate-600 dark:text-slate-400">
                                                <li>• <a href="#" className="hover:underline">Lire le Whitepaper</a></li>
                                                <li>• <a href="#" className="hover:underline">Audit du Smart Contract</a></li>
                                                <li>• <a href="#" className="hover:underline">Support Discord</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                  </div>
                )}

                {/* --- VUE ASSUREUR --- */}
                {activeRole === 'insurer' && (
                  <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in duration-500">
                    <div className="lg:col-span-4 space-y-6">
                      <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
                        <div className="flex items-center gap-3 mb-6 pb-6 border-b border-slate-100 dark:border-slate-700">
                          <div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
                            <Plus className="h-5 w-5" />
                          </div>
                          <div>
                            <h2 className="text-lg font-bold text-slate-900 dark:text-white">Nouveau Vault</h2>
                            <p className="text-xs text-slate-500 dark:text-slate-400">Déploiement Factory</p>
                          </div>
                        </div>

                        <form onSubmit={handleCreateVault} className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Nom du Risque</label>
                            <input
                              type="text"
                              value={newVaultData.name}
                              onChange={e => setNewVaultData({...newVaultData, name: e.target.value})}
                              className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                              placeholder="Ex: Florida Wind 2026"
                            />
                          </div>

                          {/* DESCRIPTION */}
                          <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Conditions de Déclenchement (Description)</label>
                            <textarea
                              value={newVaultData.description}
                              onChange={e => setNewVaultData({...newVaultData, description: e.target.value})}
                              className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all h-24 resize-none text-sm"
                              placeholder="Détaillez ici les conditions exactes (Vitesse vent, source oracle, zone...)"
                            ></textarea>
                          </div>

                          {/* DATE */}
                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Jour</label>
                              <input
                                type="number"
                                min="1"
                                max={getMaxDays(newVaultData.month)}
                                value={newVaultData.day}
                                onChange={e => {
                                    let val = parseInt(e.target.value);
                                    if(val > getMaxDays(newVaultData.month)) val = getMaxDays(newVaultData.month);
                                    if(val < 1) val = '';
                                    setNewVaultData({...newVaultData, day: val});
                                }}
                                className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="JJ"
                              />
                            </div>
                            <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Mois</label>
                            <select
                                value={newVaultData.month}
                                onChange={e => {
                                    const newMonth = e.target.value;
                                    const maxDays = getMaxDays(newMonth);
                                    let currentDay = newVaultData.day;
                                    if (currentDay > maxDays) currentDay = maxDays;
                                    setNewVaultData({...newVaultData, month: newMonth, day: currentDay});
                                }}
                                className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                            >
                                {MONTHS.map(m => (
                                    <option key={m.name} value={m.name}>{m.name}</option>
                                ))}
                            </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Année</label>
                              <input
                                type="number"
                                min={new Date().getFullYear()}
                                value={newVaultData.year}
                                onChange={e => setNewVaultData({...newVaultData, year: e.target.value})}
                                className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="AAAA"
                              />
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Capacité (USDC)</label>
                              <input
                                type="number"
                                min="0"
                                value={newVaultData.cap}
                                onChange={e => {
                                    const val = e.target.value;
                                    setNewVaultData({...newVaultData, cap: val, junior: updateJunior(val, newVaultData.juniorPercent)});
                                }}
                                className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Junior (%)</label>
                              <div className="relative">
                                <input
                                    type="number"
                                    min="0"
                                    max="100"
                                    value={newVaultData.juniorPercent}
                                    onChange={e => {
                                        const val = e.target.value;
                                        setNewVaultData({...newVaultData, juniorPercent: val, junior: updateJunior(newVaultData.cap, val)});
                                    }}
                                    className="w-full p-3 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">%</span>
                              </div>
                            </div>
                          </div>

                          {/* OPTION DE SUR-COLLATÉRALISATION */}
                          <div className="flex items-center gap-2 mb-2 mt-2">
                              <input
                                type="checkbox"
                                id="overcollat"
                                checked={isOvercollateralized}
                                onChange={(e) => setIsOvercollateralized(e.target.checked)}
                                className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-900 cursor-pointer"
                              />
                              <label htmlFor="overcollat" className="text-sm text-slate-600 dark:text-slate-400 cursor-pointer select-none font-medium">
                                  Activer la Sur-collatéralisation
                              </label>
                          </div>

                          {isOvercollateralized && (
                              <div className="mb-4 animate-fade-in p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-900">
                                  <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Montant Assuré (Claim Amount)</label>
                                  <div className="relative">
                                    <input
                                        type="number"
                                        min="0"
                                        value={newVaultData.coverage}
                                        onChange={e => setNewVaultData({...newVaultData, coverage: e.target.value})}
                                        className="w-full p-3 border border-blue-200 dark:border-blue-800 bg-white dark:bg-slate-900 text-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                    />
                                    <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 font-bold">USDC</span>
                                  </div>
                                  <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                                      Ce montant est celui qui sera réellement couvert en cas de sinistre. Il peut être inférieur à la capacité levée (sur-collatéralisation).
                                  </p>
                              </div>
                          )}

                          {/* Montant Junior Calculé */}
                          <div className="bg-slate-50 dark:bg-slate-900/50 p-3 rounded-xl border border-slate-200 dark:border-slate-700 flex justify-between items-center text-sm">
                              <span className="text-slate-500 dark:text-slate-400">Montant Junior requis:</span>
                              <span className="font-bold text-slate-900 dark:text-white">{formatCurrency(newVaultData.junior)}</span>
                          </div>

                          {/* Prime */}
                          <div>
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5">Prime à Payer (Yield Boost)</label>
                            <div className="relative">
                              <input
                                type="number"
                                min="0"
                                value={newVaultData.premium}
                                onChange={e => setNewVaultData({...newVaultData, premium: e.target.value})}
                                className="w-full p-3 pl-3 pr-16 border border-green-200 dark:border-green-800 bg-green-50/30 dark:bg-green-900/20 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-green-800 dark:text-green-400 font-medium"
                              />
                              <span className="absolute right-4 top-1/2 -translate-y-1/2 text-green-600 dark:text-green-400 text-xs font-bold">USDC</span>
                            </div>
                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">
                              Montant versé immédiatement pour booster l'APR des investisseurs.
                            </p>
                          </div>

                          <button type="submit" className="w-full mt-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-3.5 rounded-xl font-bold hover:bg-slate-800 dark:hover:bg-slate-200 transition-all shadow-lg shadow-slate-200 dark:shadow-none">
                            Déployer le Contrat
                          </button>
                        </form>
                      </div>

                      {/* Status Card */}
                      <div className="bg-indigo-600 dark:bg-indigo-700 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200 dark:shadow-none">
                        <div className="flex items-center gap-3 mb-4">
                          <Shield className="h-6 w-6 opacity-80" />
                          <h3 className="font-bold">Espace VUSA</h3>
                        </div>
                        <p className="text-indigo-100 text-sm mb-4 leading-relaxed">
                          Votre statut d'assureur est vérifié (Whitelist). Vos fonds Junior Tranche sont verrouillés en "First Loss" jusqu'à maturité.
                        </p>
                        <div className="bg-white/10 p-3 rounded-lg backdrop-blur-sm border border-white/10">
                          <div className="flex justify-between text-xs font-mono mb-1">
                            <span className="opacity-70">STATUS</span>
                            <span className="text-green-300">VERIFIED</span>
                          </div>
                          <div className="flex justify-between text-xs font-mono">
                            <span className="opacity-70">ENTITY</span>
                            <span>State Farm Re</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Main content Assureur */}
                    <div className="lg:col-span-8">
                      <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-6">Vos Vaults Gérés</h3>

                      <div className="space-y-4">
                        {vaults.map((vault) => (
                          <div key={vault.id} className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 flex flex-col md:flex-row items-center justify-between gap-6 hover:shadow-md transition-shadow">
                            <div className="flex-1">
                              <div className="flex items-center gap-3 mb-2">
                                <h4 className="text-lg font-bold text-slate-900 dark:text-white">{vault.name}</h4>
                                {vault.status === 'PENDING' && <span className="px-2.5 py-1 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 text-xs font-bold rounded-md">PENDING</span>}
                                {vault.status === 'OPEN' && <span className="px-2.5 py-1 bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-400 text-xs font-bold rounded-md">ACTIVE</span>}
                              </div>
                              <div className="flex gap-6 text-sm text-slate-500 dark:text-slate-400">
                                <span>Capacité: <strong>{formatCurrency(vault.totalCapacity)}</strong></span>
                                <span>Junior: <strong>{formatCurrency(vault.juniorCapital)}</strong></span>
                              </div>
                              {vault.totalCapacity > (vault.claimAmount || vault.totalCapacity) && (
                                  <div className="mt-2 text-xs text-green-700 dark:text-green-400 font-medium bg-green-50 dark:bg-green-900/30 inline-block px-2 py-1 rounded">
                                      Couverture Max: {formatCurrency(vault.claimAmount)} (Sur-collatéralisé)
                                  </div>
                              )}
                            </div>

                            {vault.status === 'PENDING' ? (
                              <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                                <div className="text-right">
                                  <p className="text-xs text-slate-500 dark:text-slate-400 mb-1">Total à financer (Junior + Prime)</p>
                                  <p className="font-bold text-slate-900 dark:text-white">{formatCurrency(vault.juniorCapital + vault.premium)}</p>
                                </div>
                                <button
                                  onClick={() => handleInitializeVault(vault.id)}
                                  className="w-full md:w-auto px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors shadow-sm"
                                >
                                  Financer & Ouvrir
                                </button>
                              </div>
                            ) : (
                              <div className="flex items-center gap-4 bg-slate-50 dark:bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-100 dark:border-slate-700">
                                <div className="text-right">
                                  <p className="text-xs text-slate-400 dark:text-slate-500">Fonds levés</p>
                                  <p className="font-bold text-slate-700 dark:text-slate-300">{formatCurrency(vault.currentAssets)}</p>
                                </div>
                                <div className="h-8 w-px bg-slate-200 dark:bg-slate-700"></div>
                                <div className="text-right">
                                  <p className="text-xs text-slate-400 dark:text-slate-500">APR Public</p>
                                  <p className="font-bold text-green-600 dark:text-green-400">{vault.apr}%</p>
                                </div>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* --- VUE ORACLE --- */}
                {activeRole === 'oracle' && (
                  <div className="max-w-3xl mx-auto animate-in fade-in duration-500">
                    <div className="text-center mb-10">
                      <div className="w-20 h-20 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-100 dark:border-red-800">
                        <Wind className="h-10 w-10 text-red-600 dark:text-red-400" />
                      </div>
                      <h2 className="text-3xl font-bold text-slate-900 dark:text-white">Oracle Dashboard</h2>
                      <p className="text-slate-500 dark:text-slate-400 mt-2">Interface de surveillance des triggers paramétriques</p>
                    </div>

                    <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                      <div className="p-6 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                          <Activity className="h-4 w-4" /> Flux de Données en Temps Réel
                        </h3>
                        <span className="flex h-3 w-3 relative">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                      </div>

                      <div className="divide-y divide-slate-100 dark:divide-slate-700">
                        {vaults.filter(v => v.status === 'OPEN').map(vault => (
                          <div key={vault.id} className="p-8">
                            <div className="flex justify-between items-start mb-6">
                              <div>
                                <h4 className="text-xl font-bold text-slate-900 dark:text-white">{vault.name}</h4>
                                <p className="text-xs font-mono text-slate-400 dark:text-slate-500 mt-1">{vault.id}</p>
                              </div>
                              <div className="flex flex-col items-end gap-1">
                                <div className="px-3 py-1 bg-slate-100 dark:bg-slate-700 rounded-full text-xs font-bold text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600">
                                    MONITORING ACTIVE
                                </div>
                                <span className="text-xs font-medium text-slate-400 dark:text-slate-500">Modèle de Risque: {vault.riskProb}%</span>
                              </div>
                            </div>

                            <div className="grid grid-cols-2 gap-6 mb-8">
                              <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Seuil de Déclenchement</p>
                                <p className="text-2xl font-mono font-bold text-slate-900 dark:text-white">
                                  {vault.triggerValue} <span className="text-sm font-sans font-normal text-slate-500 dark:text-slate-400">unités</span>
                                </p>
                              </div>
                              <div className="bg-white dark:bg-slate-900/30 p-4 rounded-xl border-2 border-green-100 dark:border-green-800 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-10">
                                  <Activity className="h-16 w-16 text-green-600 dark:text-green-400" />
                                </div>
                                <p className="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Donnée Capteur (Live)</p>
                                <p className="text-2xl font-mono font-bold text-green-600 dark:text-green-400">
                                  {Math.floor(vault.triggerValue * 0.2)} <span className="text-sm font-sans font-normal text-slate-400 dark:text-slate-500">/ {vault.triggerValue}</span>
                                </p>
                              </div>
                            </div>

                            <div className="border-t border-slate-100 dark:border-slate-700 pt-6">
                              <div className="flex items-center gap-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-xl">
                                <div className="p-2 bg-white dark:bg-slate-800 rounded-full border border-red-100 dark:border-red-900 shadow-sm">
                                  <AlertTriangle className="h-6 w-6 text-red-600 dark:text-red-400" />
                                </div>
                                <div className="flex-1">
                                  <p className="font-bold text-red-900 dark:text-red-300">Zone de Test (Simulation)</p>
                                  <p className="text-xs text-red-700 dark:text-red-400">
                                    Simuler une catastrophe envoie une transaction `triggerCatastrophe()` au Smart Contract.
                                  </p>
                                </div>
                                <button
                                  onClick={() => handleTriggerOracle(vault.id)}
                                  className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold shadow-lg shadow-red-200 dark:shadow-none transition-all active:scale-95"
                                >
                                  SIMULER CRASH
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}

                        {vaults.filter(v => v.status === 'OPEN').length === 0 && (
                          <div className="p-12 text-center">
                            <p className="text-slate-400 dark:text-slate-500 mb-2">Aucun vault actif à surveiller.</p>
                            <button onClick={() => setActiveRole('insurer')} className="text-blue-600 dark:text-blue-400 hover:underline text-sm">
                              Créer un vault en tant qu'assureur
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

              </main>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
